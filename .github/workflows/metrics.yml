name: Probe Metrics Logger

on:
  schedule:
    - cron: '*/5 * * * *' # Every 5 minutes
  workflow_dispatch:

permissions:
  actions: read
  contents: read

concurrency:
  # Serialize runs of this workflow so they don't clobber each-other.
  group: probe-metrics-${{ github.ref }}
  cancel-in-progress: false

jobs:
  log-metrics:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Prepare tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq unzip || true

      - name: Restore previous probe-metrics artifact (if any)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          WORKFLOW_FILE: probe-metrics-logger.yml
          ARTIFACT_NAME: probe-metrics
        run: |
          set -euo pipefail
          mkdir -p metrics

          echo "Looking for recent completed runs of workflow file: $WORKFLOW_FILE"
          # Request several recent completed runs (no invalid 'status=success' param)
          runs_api="https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_FILE/runs?per_page=10&status=completed"
          runs_json=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$runs_api")
          echo "runs_json: $runs_json" >&2

          # Iterate runs until we find an artifact named $ARTIFACT_NAME
          run_ids=$(echo "$runs_json" | jq -r '.workflow_runs[].id // empty')
          found_artifact=""
          for rid in $run_ids; do
            echo "Checking run id: $rid" >&2
            artifacts_api="https://api.github.com/repos/$REPO/actions/runs/$rid/artifacts"
            artifacts_json=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$artifacts_api")
            echo "artifacts_json for run $rid: $artifacts_json" >&2

            artifact_id=$(echo "$artifacts_json" | jq -r --arg name "$ARTIFACT_NAME" '.artifacts[] | select(.name == $name) | .id // empty')
            if [ -n "$artifact_id" ]; then
              echo "Found artifact $ARTIFACT_NAME in run $rid -> id $artifact_id"
              found_artifact="$artifact_id"
              break
            fi
          done

          if [ -z "$found_artifact" ]; then
            echo "No previous artifact found. Creating metrics/metrics.csv with header (if you want headers)."
            if [ ! -f metrics/metrics.csv ]; then
              echo "timestamp,findTime,createTime,commentTime,spinTime,moveTime,viewTime,deleteCommentTime,deleteSpinTime,totalTime" > metrics/metrics.csv
            fi
            exit 0
          fi

          # Download and extract the artifact
          artifact_zip_url="https://api.github.com/repos/$REPO/actions/artifacts/$found_artifact/zip"
          curl -sL -H "Authorization: token $GITHUB_TOKEN" -o previous_artifact.zip "$artifact_zip_url"

          unzip -o previous_artifact.zip -d previous_artifact >/dev/null || true

          if [ -f previous_artifact/metrics/metrics.csv ]; then
            cp previous_artifact/metrics/metrics.csv metrics/metrics.csv
            echo "Restored previous metrics/metrics.csv."
          elif [ -f previous_artifact/metrics.csv ]; then
            cp previous_artifact/metrics.csv metrics/metrics.csv
            echo "Restored previous metrics.csv."
          else
            echo "Artifact did not contain metrics/metrics.csv; creating new metrics/metrics.csv"
            if [ ! -f metrics/metrics.csv ]; then
              echo "timestamp,findTime,createTime,commentTime,spinTime,moveTime,viewTime,deleteCommentTime,deleteSpinTime,totalTime" > metrics/metrics.csv
            fi
          fi

      - name: Ensure metrics directory exists
        run: mkdir -p ./metrics

      - name: Run metrics.js (update metrics/metrics.csv)
        env:
          APIKEY: ${{ secrets.APIKEY }}
        run: |
          node scripts/metrics.js

      - name: Show tail of metrics/metrics.csv
        run: |
          echo "---- tail of metrics/metrics.csv ----"
          tail -n 30 metrics/metrics.csv || true
          echo "-------------------------------------"

      - name: Upload updated metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: probe-metrics
          path: |
            metrics/metrics.csv

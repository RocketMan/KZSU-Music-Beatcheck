name: Probe Metrics Logger

on:
  schedule:
    - cron: '*/5 * * * *' # Every 5 minutes
  workflow_dispatch:

permissions:
  actions: read
  contents: read

concurrency:
  group: probe-metrics-${{ github.ref }}
  cancel-in-progress: false

jobs:
  log-metrics:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Prepare tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq unzip || true

      - name: Restore previous probe-metrics artifact (robust lookup)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          WORKFLOW_FILE: probe-metrics-logger.yml
          ARTIFACT_NAME: probe-metrics
        run: |
          set -euo pipefail
          mkdir -p metrics

          echo "Listing workflows for repository $REPO to find the workflow id for $WORKFLOW_FILE"
          workflows_api="https://api.github.com/repos/$REPO/actions/workflows?per_page=100"
          workflows_json=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$workflows_api")
          echo "workflows_json: $workflows_json" >&2

          # Try to find a workflow whose path ends with the filename (handles .github/workflows/<file>)
          workflow_id=$(echo "$workflows_json" | jq -r --arg wf "$WORKFLOW_FILE" '.workflows[] | select(.path | endswith($wf)) | .id // empty' | head -n1)

          # If not found, try matching by name exactly as a fallback (less reliable)
          if [ -z "$workflow_id" ]; then
            workflow_id=$(echo "$workflows_json" | jq -r --arg wf "$WORKFLOW_FILE" '.workflows[] | select(.name == $wf) | .id // empty' | head -n1)
          fi

          if [ -z "$workflow_id" ]; then
            echo "Could not find workflow matching '$WORKFLOW_FILE' in repository $REPO."
            echo "Check that the workflow file exists at .github/workflows/$WORKFLOW_FILE on the default branch,"
            echo "that the filename matches exactly (case and extension), and that the GITHUB_TOKEN has actions:read."
            # Print available workflow paths to help debugging
            echo "Available workflow paths:"
            echo "$workflows_json" | jq -r '.workflows[].path' || true
            # Fall back to creating an initial CSV so the run can continue
            if [ ! -f metrics/metrics.csv ]; then
              echo "timestamp,findTime,createTime,commentTime,spinTime,moveTime,viewTime,deleteCommentTime,deleteSpinTime,totalTime" > metrics/metrics.csv
            fi
            exit 0
          fi

          echo "Found workflow id: $workflow_id for file $WORKFLOW_FILE"

          echo "Looking for recent completed runs for workflow id $workflow_id"
          runs_api="https://api.github.com/repos/$REPO/actions/workflows/$workflow_id/runs?per_page=20&status=completed"
          runs_json=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$runs_api")
          echo "runs_json: $runs_json" >&2

          run_ids=$(echo "$runs_json" | jq -r '.workflow_runs[].id // empty')
          found_artifact=""
          for rid in $run_ids; do
            echo "Checking run id: $rid" >&2
            artifacts_api="https://api.github.com/repos/$REPO/actions/runs/$rid/artifacts"
            artifacts_json=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$artifacts_api")
            echo "artifacts_json for run $rid: $artifacts_json" >&2

            artifact_id=$(echo "$artifacts_json" | jq -r --arg name "$ARTIFACT_NAME" '.artifacts[] | select(.name == $name) | .id // empty')
            if [ -n "$artifact_id" ]; then
              echo "Found artifact $ARTIFACT_NAME in run $rid -> id $artifact_id"
              found_artifact="$artifact_id"
              break
            fi
          done

          if [ -z "$found_artifact" ]; then
            echo "No previous artifact found. Creating metrics/metrics.csv with header (if you want headers)."
            if [ ! -f metrics/metrics.csv ]; then
              echo "timestamp,findTime,createTime,commentTime,spinTime,moveTime,viewTime,deleteCommentTime,deleteSpinTime,totalTime" > metrics/metrics.csv
            fi
            exit 0
          fi

          echo "Downloading artifact id $found_artifact..."
          artifact_zip_url="https://api.github.com/repos/$REPO/actions/artifacts/$found_artifact/zip"
          curl -sL -H "Authorization: token $GITHUB_TOKEN" -o previous_artifact.zip "$artifact_zip_url"

          unzip -o previous_artifact.zip -d previous_artifact >/dev/null || true

          if [ -f previous_artifact/metrics/metrics.csv ]; then
            cp previous_artifact/metrics/metrics.csv metrics/metrics.csv
            echo "Restored previous metrics/metrics.csv."
          elif [ -f previous_artifact/metrics.csv ]; then
            cp previous_artifact/metrics.csv metrics/metrics.csv
            echo "Restored previous metrics.csv."
          else
            echo "Artifact did not contain metrics/metrics.csv; creating new metrics/metrics.csv"
            if [ ! -f metrics/metrics.csv ]; then
              echo "timestamp,findTime,createTime,commentTime,spinTime,moveTime,viewTime,deleteCommentTime,deleteSpinTime,totalTime" > metrics/metrics.csv
            fi
          fi

      - name: Run metrics.js (update metrics/metrics.csv)
        env:
          APIKEY: ${{ secrets.APIKEY }}
        run: |
          node scripts/metrics.js

      - name: Show tail of metrics/metrics.csv
        run: |
          echo "---- tail of metrics/metrics.csv ----"
          tail -n 30 metrics/metrics.csv || true
          echo "-------------------------------------"

      - name: Upload updated metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: probe-metrics
          path: |
            metrics/metrics.csv

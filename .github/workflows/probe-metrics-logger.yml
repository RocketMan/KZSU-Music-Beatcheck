name: Probe Metrics Logger

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  actions: read
  contents: read

concurrency:
  group: probe-metrics-${{ github.ref }}
  cancel-in-progress: false

env:
  LOOKBACK_RUNS: "10"
  ARTIFACT_NAME: "probe-metrics"
  WORKFLOW_FILE: "probe-metrics-logger.yml"

jobs:
  log-metrics:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Prepare tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq unzip || true

      - name: Restore previous probe-metrics artifact
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          mkdir -p metrics

          LOOKBACK=${LOOKBACK_RUNS:-10}
          WF_FILE=${WORKFLOW_FILE:-probe-metrics-logger.yml}
          ART_NAME=${ARTIFACT_NAME:-probe-metrics}
          echo "Looking up workflow id for $WF_FILE in $REPO"

          workflows_api="https://api.github.com/repos/$REPO/actions/workflows?per_page=100"
          workflows_json=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$workflows_api")
          workflow_id=$(echo "$workflows_json" | jq -r --arg wf "$WF_FILE" '.workflows[] | select(.path | endswith($wf)) | .id // empty' | head -n1)

          if [ -z "$workflow_id" ]; then
            # fallback: try exact name match
            workflow_id=$(echo "$workflows_json" | jq -r --arg wf "$WF_FILE" '.workflows[] | select(.name == $wf) | .id // empty' | head -n1)
          fi

          if [ -z "$workflow_id" ]; then
            echo "Could not find workflow file $WF_FILE. Available workflow paths:"
            echo "$workflows_json" | jq -r '.workflows[].path' || true
            if [ ! -f metrics/metrics.csv ]; then
              echo "timestamp,findTime,createTime,commentTime,spinTime,moveTime,viewTime,deleteCommentTime,deleteSpinTime,totalTime" > metrics/metrics.csv
            fi
            exit 0
          fi

          echo "Found workflow id: $workflow_id. Looking back up to $LOOKBACK runs for artifact: $ART_NAME"

          runs_api="https://api.github.com/repos/$REPO/actions/workflows/$workflow_id/runs?per_page=$LOOKBACK&status=completed"
          runs_json=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$runs_api")
          run_ids=$(echo "$runs_json" | jq -r '.workflow_runs[].id // empty')

          found_artifact=""
          for rid in $run_ids; do
            echo "Checking run id: $rid"
            artifacts_api="https://api.github.com/repos/$REPO/actions/runs/$rid/artifacts"
            artifacts_json=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$artifacts_api")
            artifact_id=$(echo "$artifacts_json" | jq -r --arg name "$ART_NAME" '.artifacts[] | select(.name == $name) | .id // empty')
            if [ -n "$artifact_id" ]; then
              echo "Found artifact $ART_NAME in run $rid -> id $artifact_id"
              found_artifact="$artifact_id"
              break
            fi
          done

          if [ -z "$found_artifact" ]; then
            echo "No artifact named $ART_NAME found in the last $LOOKBACK runs. Creating fresh metrics/metrics.csv with header."
            if [ ! -f metrics/metrics.csv ]; then
              echo "timestamp,findTime,createTime,commentTime,spinTime,moveTime,viewTime,deleteCommentTime,deleteSpinTime,totalTime" > metrics/metrics.csv
            fi
            exit 0
          fi

          echo "Downloading artifact id $found_artifact..."
          artifact_zip_url="https://api.github.com/repos/$REPO/actions/artifacts/$found_artifact/zip"
          curl -sL -H "Authorization: token $GITHUB_TOKEN" -o previous_artifact.zip "$artifact_zip_url"

          unzip -o previous_artifact.zip -d previous_artifact >/dev/null || true

          if [ -f previous_artifact/metrics/metrics.csv ]; then
            cp previous_artifact/metrics/metrics.csv metrics/metrics.csv
            echo "Restored previous metrics/metrics.csv."
          elif [ -f previous_artifact/metrics.csv ]; then
            cp previous_artifact/metrics.csv metrics/metrics.csv
            echo "Restored previous metrics.csv."
          else
            echo "Artifact did not contain metrics/metrics.csv; creating new metrics/metrics.csv"
            if [ ! -f metrics/metrics.csv ]; then
              echo "timestamp,findTime,createTime,commentTime,spinTime,moveTime,viewTime,deleteCommentTime,deleteSpinTime,totalTime" > metrics/metrics.csv
            fi
          fi

      - name: Ensure metrics directory exists
        run: mkdir -p ./metrics

      - name: Run metrics.js (update metrics/metrics.csv)
        env:
          APIKEY: ${{ secrets.APIKEY }}
        run: |
          node scripts/metrics.js

      - name: Show tail of metrics/metrics.csv
        run: |
          echo "---- tail of metrics/metrics.csv ----"
          tail -n 30 metrics/metrics.csv || true
          echo "-------------------------------------"

      - name: Upload updated metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: probe-metrics
          path: metrics/metrics.csv

      - name: Cleanup duplicate artifacts (keep newest)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          ARTIFACT_NAME: probe-metrics
        run: |
          chmod +x scripts/cleanup-duplicate-artifacts.sh
          scripts/cleanup-duplicate-artifacts.sh
